<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>프로필 - AI Curator</title>
    <link href="assets/css/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="assets/css/common.css">
    <link rel="stylesheet" href="assets/css/components.css">
    <script src="js/theme-manager.js"></script>
    <script src="js/common.js"></script>

    
    <!-- 다국어 관련 스크립트는 header.html에서 이미 로드됨 -->


    
    <!-- 이 페이지에서만 사용되는 고유한 스타일 -->
    <style>
        /* 프로필 페이지 전용 스타일 (공통 CSS로 대체할 수 없는 것들만) */
        .profile-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-item {
            text-align: center;
            padding: 1rem;
            background-color: var(--card-bg);
            border-radius: 0.5rem;
        }

        .stars {
            color: #FFD700;
            letter-spacing: -1px;
        }

        /* 프로필 설정 제목 스타일 */
        .profile-settings-title {
            color: var(--text-primary);
        }

        /* 즐겨찾기 탭 스타일 */
        #favoriteToolsTab,
        #favoriteRecipesTab {
            transition: all 0.3s ease;
        }

        /* 모바일 최적화 */
        @media (max-width: 768px) {
            .profile-stats {
                grid-template-columns: repeat(3, 1fr);
                gap: 0.5rem;
            }
            
            .stat-item {
                padding: 0.75rem 0.5rem;
            }
        }
    </style>
    <script>
    window.DEFAULT_IMAGE = 'assets/icons/code-icon1.png';
    function getStorageUrl(fileName) {
        return `https://firebasestorage.googleapis.com/v0/b/ai-tools-data-b2b7b.firebasestorage.app/o/ai_logos%2F${encodeURIComponent(fileName)}?alt=media&token=4b780bb4-d39d-4195-8c73-4766eda6ad6b`;
    }
    function getValidImageUrl(tool) {
        if (typeof tool.logoUrl === 'string' && tool.logoUrl.trim() !== '') return tool.logoUrl;
        if (typeof tool.logoFileName === 'string' && tool.logoFileName.trim() !== '') {
            return getStorageUrl(tool.logoFileName);
        }
        if (typeof tool.imageUrl === 'string' && tool.imageUrl.trim() !== '') return tool.imageUrl;
        if (typeof tool.image === 'string' && tool.image.trim() !== '') return tool.image;
        return window.DEFAULT_IMAGE;
    }
    // 이미지 로드 실패 시 기본 이미지로 대체
    window.handleImageError = function(img) {
        img.onerror = null;
        img.src = window.DEFAULT_IMAGE;
    };
    </script>
</head>
<body class="bg-[var(--dark-bg)] text-white">
    <!-- header.html 포함 -->
    <div id="header-container"></div>
    <script src="js/bootstrap.js"></script>

    <!-- Profile Section -->
    <main class="container mx-auto px-4 py-8 mt-24" role="main" aria-label="사용자 프로필">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <!-- Left Column - Profile Info -->
            <div class="md:col-span-1">
                <div class="bg-[var(--card-bg)] rounded-lg p-6" role="region" aria-label="프로필 정보">
                    <div class="flex items-center mb-6">
                        <div class="w-20 h-20 bg-indigo-500 rounded-full flex items-center justify-center text-2xl font-bold mr-4" role="img" aria-label="프로필 아바타">
                            <span id="profileInitialLarge" aria-hidden="true">U</span>
                        </div>
                        <div>
                            <h1 class="text-xl font-semibold" id="profileNameDisplay">사용자</h1>
                            <p class="text-gray-400" id="profileEmail" aria-label="사용자 이메일">loading...</p>
                        </div>
                    </div>

                    <div class="profile-stats" role="region" aria-label="프로필 통계">
                        <div class="stat-item" role="group" aria-label="즐겨찾기한 AI 도구 수">
                            <div class="text-2xl font-bold text-indigo-500" id="favoriteToolsCount" aria-live="polite">0</div>
                            <div class="text-sm text-gray-400">AI 도구</div>
                        </div>
                        <div class="stat-item" role="group" aria-label="즐겨찾기한 AI 레시피 수">
                            <div class="text-2xl font-bold text-indigo-500" id="favoriteRecipesCount" aria-live="polite">0</div>
                            <div class="text-sm text-gray-400">AI 레시피</div>
                        </div>
                        <div class="stat-item" role="group" aria-label="리뷰 수">
                            <div class="text-2xl font-bold text-indigo-500">0</div>
                            <div class="text-sm text-gray-400">리뷰</div>
                        </div>
                    </div>

                    <div class="mt-6" role="region" aria-label="계정 설정">
                        <h2 class="profile-settings-title text-lg font-semibold mb-4">계정 설정</h2>
                        <form class="space-y-4" role="form" aria-label="프로필 수정 폼">
                            <div>
                                <label for="displayName" class="block text-sm font-medium text-gray-400 mb-1">이름</label>
                                <input type="text" id="displayName" name="displayName" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2" aria-describedby="displayNameHelp">
                                <div id="displayNameHelp" class="sr-only">사용자 표시 이름을 입력하세요</div>
                            </div>
                            <div>
                                <label for="email" class="block text-sm font-medium text-gray-400 mb-1">이메일</label>
                                <input type="email" id="email" name="email" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2" disabled aria-describedby="emailHelp">
                                <div id="emailHelp" class="sr-only">이메일은 변경할 수 없습니다</div>
                            </div>
                            <button type="submit" id="saveChanges" class="w-full bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 transition-colors" aria-label="변경사항 저장">
                                변경사항 저장
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Right Column - Favorite Tools -->
            <div class="md:col-span-2">
                <!-- 탭 네비게이션 -->
                <div class="flex space-x-1 mb-6 bg-gray-700 rounded-lg p-1" role="tablist" aria-label="즐겨찾기 탭">
                    <button id="favoriteToolsTab" class="flex-1 py-2 px-4 rounded-md bg-indigo-500 text-white font-medium transition-colors" role="tab" aria-selected="true" aria-controls="favoriteToolsSection">
                        즐겨찾기한 AI 도구
                    </button>
                    <button id="favoriteRecipesTab" class="flex-1 py-2 px-4 rounded-md bg-gray-600 text-gray-300 font-medium hover:bg-gray-500 transition-colors" role="tab" aria-selected="false" aria-controls="favoriteRecipesSection">
                        즐겨찾기한 AI 레시피
                    </button>
                </div>

                <!-- AI 도구 탭 -->
                <div id="favoriteToolsSection" role="tabpanel" aria-labelledby="favoriteToolsTab">
                    <h2 class="text-2xl font-bold mb-6">즐겨찾기한 AI 도구</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="favoriteToolsContainer" aria-live="polite" aria-label="즐겨찾기한 AI 도구 목록">
                        <!-- Favorite tools will be dynamically added here -->
                    </div>
                </div>

                <!-- AI 레시피 탭 -->
                <div id="favoriteRecipesSection" class="hidden" role="tabpanel" aria-labelledby="favoriteRecipesTab" aria-hidden="true">
                    <h2 class="text-2xl font-bold mb-6">즐겨찾기한 AI 레시피</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-6" id="favoriteRecipesContainer" aria-live="polite" aria-label="즐겨찾기한 AI 레시피 목록">
                        <!-- Favorite recipes will be dynamically added here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- footer.html 포함 -->
    <div id="footer-container"></div>

    <!-- 모바일 메뉴 (숨김 상태로 시작) -->
    <div id="mobileMenu" class="fixed top-0 right-0 w-64 h-full bg-gray-900 z-50 shadow-lg transform translate-x-full transition-transform duration-300 md:hidden">
        <div class="flex justify-end p-4">
            <button id="closeMobileMenu" class="text-gray-300 text-2xl">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <nav class="flex flex-col space-y-4 px-6">
            <button onclick="location.href='question_recommendation.html'" class="text-gray-300 text-left">AI 추천 테스트</button>
            <button onclick="location.href='filter_search.html'" class="text-gray-300 text-left">AI 도구 찾기</button>
            <button onclick="showLoginModal()" class="text-gray-300 text-left">로그인</button>
            <button onclick="showSignupModal()" class="text-gray-300 text-left">회원가입</button>
            <button id="mobileThemeToggle" class="text-gray-300 text-left">테마 변경</button>
        </nav>
    </div>

    <style>
    [data-theme="light"] #mobileMenu {
        background-color: #fff !important;
    }
    [data-theme="light"] #mobileMenu button,
    [data-theme="light"] #mobileMenu nav button {
        color: #222 !important;
    }
    [data-theme="light"] #mobileMenu #closeMobileMenu {
        color: #222 !important;
    }
    [data-theme="light"] footer {
        background-color: #fff !important;
        color: #222 !important;
    }
    [data-theme="light"] footer h3,
    [data-theme="light"] footer a,
    [data-theme="light"] footer p,
    [data-theme="light"] footer li,
    [data-theme="light"] footer span {
        color: #222 !important;
    }
            [data-theme="light"] footer .border-gray-800 {
            border-color: #e5e7eb !important;
        }
        [data-theme="light"] #favoriteToolsTab,
        [data-theme="light"] #favoriteRecipesTab {
            color: #1a202c !important;
        }
        [data-theme="light"] #favoriteToolsTab.bg-indigo-500 {
            background-color: #4f46e5 !important;
            color: #ffffff !important;
        }
        [data-theme="light"] #favoriteRecipesTab.bg-indigo-500 {
            background-color: #4f46e5 !important;
            color: #ffffff !important;
        }
    </style>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const openBtn = document.getElementById('openMobileMenu');
        const closeBtn = document.getElementById('closeMobileMenu');
        const mobileMenu = document.getElementById('mobileMenu');
        const mobileThemeToggle = document.getElementById('mobileThemeToggle');

        if (openBtn && mobileMenu) {
            openBtn.addEventListener('click', function() {
                mobileMenu.classList.remove('translate-x-full');
                mobileMenu.classList.add('translate-x-0');
                document.body.style.overflow = 'hidden';
            });
        }
        if (closeBtn && mobileMenu) {
            closeBtn.addEventListener('click', function() {
                mobileMenu.classList.remove('translate-x-0');
                mobileMenu.classList.add('translate-x-full');
                document.body.style.overflow = '';
            });
        }
        // 바깥 영역 클릭 시 닫기
        mobileMenu.addEventListener('click', function(e) {
            if (e.target === mobileMenu) {
                mobileMenu.classList.remove('translate-x-0');
                mobileMenu.classList.add('translate-x-full');
                document.body.style.overflow = '';
            }
        });
        // 모바일 테마 변경 버튼 동작 추가
        if (mobileThemeToggle) {
            mobileThemeToggle.addEventListener('click', function() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                // 아이콘도 변경 (PC와 동일하게)
                const themeIcon = document.querySelector('#themeToggle i');
                if (themeIcon) {
                    if (newTheme === 'dark') {
                        themeIcon.className = 'fas fa-sun';
                    } else {
                        themeIcon.className = 'fas fa-moon';
                    }
                }
            });
        }
    });
    </script>

    <!-- Firebase SDK 스크립트 -->
    <script type="module">
        // Firebase SDK 임포트
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { 
            getAuth, 
            signOut,
            onAuthStateChanged 
        } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, collection, getDocs, doc, deleteDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // AuthManager를 통한 통합 초기화 사용
        const auth = window.auth;
        const db = window.db;

        // 탭 전환 함수
        function switchTab(tabName) {
            const toolsTab = document.getElementById('favoriteToolsTab');
            const recipesTab = document.getElementById('favoriteRecipesTab');
            const toolsSection = document.getElementById('favoriteToolsSection');
            const recipesSection = document.getElementById('favoriteRecipesSection');

            if (tabName === 'tools') {
                // AI 도구 탭 활성화
                toolsTab.className = 'flex-1 py-2 px-4 rounded-md bg-indigo-500 text-white font-medium transition-colors';
                toolsTab.setAttribute('aria-selected', 'true');
                recipesTab.className = 'flex-1 py-2 px-4 rounded-md bg-gray-600 text-gray-300 font-medium hover:bg-gray-500 transition-colors';
                recipesTab.setAttribute('aria-selected', 'false');
                
                toolsSection.classList.remove('hidden');
                toolsSection.setAttribute('aria-hidden', 'false');
                recipesSection.classList.add('hidden');
                recipesSection.setAttribute('aria-hidden', 'true');
                
                // 포커스 이동
                toolsTab.focus();
            } else {
                // AI 레시피 탭 활성화
                toolsTab.className = 'flex-1 py-2 px-4 rounded-md bg-gray-600 text-gray-300 font-medium hover:bg-gray-500 transition-colors';
                toolsTab.setAttribute('aria-selected', 'false');
                recipesTab.className = 'flex-1 py-2 px-4 rounded-md bg-indigo-500 text-white font-medium transition-colors';
                recipesTab.setAttribute('aria-selected', 'true');
                
                toolsSection.classList.add('hidden');
                toolsSection.setAttribute('aria-hidden', 'true');
                recipesSection.classList.remove('hidden');
                recipesSection.setAttribute('aria-hidden', 'false');
                
                // 포커스 이동
                recipesTab.focus();
            }
        }

        // 로그인 상태 감지: AuthManager 준비 후 리스너 부착
        function attachAuthListener() {
            try {
                onAuthStateChanged(getAuth(), (user) => {
                    const authButtons = document.getElementById('authButtons');
                    const profileMenu = document.getElementById('profileMenu');
                    if (user) {
                        // 헤더 토글: 로그인 시
                        if (authButtons) authButtons.style.display = 'none';
                        if (profileMenu) profileMenu.style.display = 'flex';
                        // 사용자 프로필 정보 표시 (안전하게)
                        const profileNameDisplay = document.getElementById('profileNameDisplay');
                        const profileEmail = document.getElementById('profileEmail');
                        const profileInitialLarge = document.getElementById('profileInitialLarge');
                        const displayNameInput = document.getElementById('displayName');
                        const emailInput = document.getElementById('email');
                        
                        if (profileNameDisplay) {
                            profileNameDisplay.textContent = user.displayName || user.email.split('@')[0];
                        }
                        if (profileEmail) {
                            profileEmail.textContent = user.email;
                        }
                        if (profileInitialLarge) {
                            profileInitialLarge.textContent = (user.displayName || user.email)[0].toUpperCase();
                        }
                        if (displayNameInput) {
                            displayNameInput.value = user.displayName || '';
                        }
                        if (emailInput) {
                            emailInput.value = user.email;
                        }
                        
                        // 탭 이벤트 리스너 설정 (안전하게)
                        const toolsTab = document.getElementById('favoriteToolsTab');
                        const recipesTab = document.getElementById('favoriteRecipesTab');
                        
                        if (toolsTab) {
                            toolsTab.addEventListener('click', () => switchTab('tools'));
                        }
                        if (recipesTab) {
                            recipesTab.addEventListener('click', () => switchTab('recipes'));
                        }
                        
                        // 즐겨찾기 도구/레시피 로드 함수 호출
                        loadFavoriteTools(user);
                        loadFavoriteRecipes(user);
                        
                        // 변경사항 저장 버튼 이벤트 리스너
                        setupSaveChangesListener(user);
                    } else {
                        // 헤더 토글: 로그아웃 시
                        if (authButtons) authButtons.style.display = 'flex';
                        if (profileMenu) profileMenu.style.display = 'none';
                        // 로그인되지 않은 경우 홈페이지로 리다이렉트
                        window.location.href = 'index.html';
                    }
                });
            } catch (e) {
                if (window.CommonUtils) {
                    window.CommonUtils.handleError(e, '프로필 인증 리스너 연결');
                } else {
                    console.error('프로필 인증 리스너 연결 실패:', e);
                }
            }
        }

        // 즐겨찾기 도구 로드 함수
        async function loadFavoriteTools(user) {
            try {
                const favoritesCol = collection(db, `users/${user.uid}/favorites`);
                const favoriteSnapshot = await getDocs(favoritesCol);
                const favoriteToolsCountElem = document.getElementById('favoriteToolsCount');
                const favoriteToolsContainer = document.getElementById('favoriteToolsContainer');
                
                if (favoriteToolsCountElem) {
                    favoriteToolsCountElem.textContent = favoriteSnapshot.size;
                }
                
                if (favoriteSnapshot.empty) {
                    if (favoriteToolsContainer) {
                        favoriteToolsContainer.innerHTML = '<div class="text-gray-400 text-center py-8"><i class="fas fa-bookmark text-4xl mb-4 opacity-50"></i><p class="text-lg">저장한 도구가 없습니다.</p></div>';
                    }
                } else {
                    favoriteToolsContainer.innerHTML = '';
                    favoriteSnapshot.forEach(docSnap => {
                        const tool = docSnap.data();
                        if (favoriteToolsContainer) {
                            favoriteToolsContainer.innerHTML += createToolCard({
                                name: tool.name,
                                description: tool.description,
                                image: tool.imageUrl,
                                rating: tool.rating || 0,
                                reviewCount: tool.reviewCount || 0,
                                tags: tool.tags || [],
                                type: tool.priceType || '',
                                websiteUrl: tool.websiteUrl || '',
                                logoUrl: tool.logoUrl || '',
                                logoFileName: tool.logoFileName || ''
                            }, docSnap.id);
                        }
                    });
                }
            } catch (error) {
                if (window.CommonUtils) {
                    window.CommonUtils.handleError(error, '즐겨찾기 도구 로드');
                } else {
                    console.error('즐겨찾기 도구 로드 오류:', error);
                }
                const favoriteToolsCountElem = document.getElementById('favoriteToolsCount');
                const favoriteToolsContainer = document.getElementById('favoriteToolsContainer');
                
                if (favoriteToolsCountElem) {
                    favoriteToolsCountElem.textContent = '0';
                }
                if (favoriteToolsContainer) {
                    favoriteToolsContainer.innerHTML = '<div class="text-gray-400 text-center py-8"><i class="fas fa-exclamation-triangle text-4xl mb-4 opacity-50"></i><p class="text-lg">도구를 불러오는 중 오류가 발생했습니다.</p></div>';
                }
            }
        }

        // 즐겨찾기 레시피 로드 함수
        async function loadFavoriteRecipes(user) {
            try {
                const favoriteRecipesContainer = document.getElementById('favoriteRecipesContainer');
                const favoriteRecipesCountElem = document.getElementById('favoriteRecipesCount');
                
                // 로딩 상태 표시
                favoriteRecipesContainer.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <div class="loading-skeleton w-16 h-16 rounded-full mx-auto mb-4"></div>
                        <div class="loading-skeleton w-32 h-4 mx-auto mb-2"></div>
                        <div class="loading-skeleton w-24 h-3 mx-auto"></div>
                    </div>
                `;
                
                // AI 도구 정보와 공개 레시피 정보 로드
                await Promise.all([
                    loadToolImages(),
                    loadPublicRecipes()
                ]);
                
                // 컬렉션 존재 여부 확인을 위한 안전한 접근
                try {
                    const favoriteRecipesCol = collection(db, `users/${user.uid}/favorited_recipe`);
                    const favoriteRecipesSnapshot = await getDocs(favoriteRecipesCol);
                    
                    if (favoriteRecipesCountElem) {
                        favoriteRecipesCountElem.textContent = favoriteRecipesSnapshot.size;
                    }
                    
                    if (favoriteRecipesSnapshot.empty) {
                        favoriteRecipesContainer.innerHTML = '<div class="col-span-full text-center py-8 text-gray-400"><i class="fas fa-bookmark text-4xl mb-4 opacity-50"></i><p class="text-lg">저장한 레시피가 없습니다.</p></div>';
                    } else {
                        favoriteRecipesContainer.innerHTML = '';
                        
                        // 레시피 카드들을 순차적으로 생성 (비동기 처리)
                        for (const docSnap of favoriteRecipesSnapshot.docs) {
                            const recipeData = docSnap.data();
                            recipeData.docId = docSnap.id;
                            
                            // public_recipe_collection에서 상세 정보 가져오기
                            if (window.publicRecipesCache && window.publicRecipesCache[docSnap.id]) {
                                const publicRecipe = window.publicRecipesCache[docSnap.id];
                                recipeData = { ...recipeData, ...publicRecipe };
                            }
                            
                            const recipeCard = await createRecipeCard(recipeData, docSnap.id);
                            favoriteRecipesContainer.appendChild(recipeCard);
                        }
                    }
                } catch (firestoreError) {
                    // 권한 오류 또는 컬렉션이 존재하지 않는 경우
                    console.log('즐겨찾기 레시피 컬렉션이 존재하지 않거나 접근 권한이 없습니다. 새로 생성합니다.');
                    if (favoriteRecipesCountElem) {
                        favoriteRecipesCountElem.textContent = '0';
                    }
                    favoriteRecipesContainer.innerHTML = '<div class="col-span-full text-center py-8 text-gray-400"><i class="fas fa-bookmark text-4xl mb-4 opacity-50"></i><p class="text-lg">저장한 레시피가 없습니다.</p><p class="text-sm mt-2">AI 레시피를 즐겨찾기에 추가하면 여기에 표시됩니다.</p></div>';
                }
            } catch (error) {
                if (window.CommonUtils) {
                    window.CommonUtils.handleError(error, '즐겨찾기 레시피 로드');
                } else {
                    console.error('즐겨찾기 레시피 로드 오류:', error);
                }
                const favoriteRecipesContainer = document.getElementById('favoriteRecipesContainer');
                const favoriteRecipesCountElem = document.getElementById('favoriteRecipesCount');
                
                if (favoriteRecipesCountElem) {
                    favoriteRecipesCountElem.textContent = '0';
                }
                if (favoriteRecipesContainer) {
                    favoriteRecipesContainer.innerHTML = '<div class="col-span-full text-center py-8 text-gray-400"><i class="fas fa-exclamation-triangle text-4xl mb-4 opacity-50"></i><p class="text-lg">레시피를 불러오는 중 오류가 발생했습니다.</p><p class="text-sm mt-2">잠시 후 다시 시도해주세요.</p></div>';
                }
            }
        }

        // 변경사항 저장 리스너 설정
        function setupSaveChangesListener(user) {
            const saveChangesBtn = document.getElementById('saveChanges');
            if (saveChangesBtn) {
                saveChangesBtn.addEventListener('click', async () => {
                    try {
                        const displayNameInput = document.getElementById('displayName');
                        const newDisplayName = displayNameInput ? displayNameInput.value : '';
                        // Firestore에 이름만 업데이트하려면 users/{uid} 문서에 setDoc 사용 가능
                        // 여기서는 RTDB 예시이므로 필요시 Firestore로 변경
                        // await setDoc(doc(db, 'users', user.uid), { displayName: newDisplayName }, { merge: true });
                        if (window.CommonUtils) {
                            window.CommonUtils.showSuccess('프로필이 업데이트되었습니다.');
                        } else {
                            alert('프로필이 업데이트되었습니다.');
                        }
                    } catch (error) {
                        if (window.CommonUtils) {
                            window.CommonUtils.handleError(error, '프로필 업데이트');
                        } else {
                            console.error('프로필 업데이트 실패:', error);
                            alert('프로필 업데이트 중 오류가 발생했습니다.');
                        }
                    }
                });
            }
        }

        if (window.authManager && window.authManager.isInitialized) {
            attachAuthListener();
        } else {
            window.addEventListener('authManagerReady', attachAuthListener, { once: true });
        }

        // 로그아웃 함수
        window.handleLogout = async function() {
            try {
                await signOut(auth);
                window.location.href = 'index.html';
            } catch (error) {
                if (window.CommonUtils) {
                    window.CommonUtils.handleError(error, '로그아웃');
                } else {
                    console.error('로그아웃 실패:', error);
                    alert('로그아웃 중 오류가 발생했습니다.');
                }
            }
        };

        // AI 도구 정보 로드 함수
        async function loadToolImages() {
            try {
                const toolsRef = collection(db, 'ai-tools');
                const toolsSnapshot = await getDocs(toolsRef);
                
                window.toolImagesCache = {};
                window.toolInfoCache = {};
                
                toolsSnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.name) {
                        // 이미지 URL 저장
                        if (data.imageUrl) {
                            window.toolImagesCache[data.name] = data.imageUrl;
                        }
                        
                        // 도구 정보 저장 (아이콘 포함)
                        window.toolInfoCache[data.name] = {
                            description: data.description || `${data.name}은 다양한 작업을 지원하는 AI 도구입니다.`,
                            category: data.category || '',
                            difficulty: data.difficulty || '',
                            websiteUrl: data.websiteUrl || '',
                            tags: data.tags || [],
                            icon: data.icon || 'fas fa-cog' // 아이콘 정보 추가
                        };
                    }
                });
                
                console.log(`${Object.keys(window.toolInfoCache).length}개의 AI 도구 정보를 로드했습니다.`);
            } catch (error) {
                console.error('AI 도구 정보 로드 오류:', error);
                // 오류가 발생해도 기본 캐시 객체는 생성
                window.toolImagesCache = {};
                window.toolInfoCache = {};
            }
        }

        // public_recipe_collection에서 레시피 로드 함수
        async function loadPublicRecipes() {
            try {
                const recipesRef = collection(db, 'public_recipe_collection');
                const recipesSnapshot = await getDocs(recipesRef);
                
                window.publicRecipesCache = {};
                
                recipesSnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.my_recipe_title) {
                        window.publicRecipesCache[doc.id] = {
                            id: doc.id,
                            title: data.my_recipe_title,
                            description: data.my_recipe_basic_description || '',
                            category: data.my_recipe_category || '',
                            tools: data.my_recipe_tool || [],
                            user_id: data.user_id || '',
                            created_at: data.created_at || '',
                            recipe_type: data.recipe_type || 'basic',
                            recipe_share: data.recipe_share || 'Public'
                        };
                    }
                });
                
                console.log(`${Object.keys(window.publicRecipesCache).length}개의 공개 레시피를 로드했습니다.`);
            } catch (error) {
                console.error('공개 레시피 로드 오류:', error);
                window.publicRecipesCache = {};
            }
        }

        // 아바타 색상 생성 함수
        function getAvatarColor(userId) {
            const colors = ['bg-purple-500', 'bg-blue-500', 'bg-red-500', 'bg-yellow-500', 'bg-pink-500', 'bg-green-500'];
            if (!userId) return colors[0];
            const hash = userId.split('').reduce((a, b) => {
                a = ((a << 5) - a) + b.charCodeAt(0);
                return a & a;
            }, 0);
            return colors[Math.abs(hash) % colors.length];
        }

        // 도구 색상 생성 함수
        function getToolColor(toolName) {
            const colors = ['bg-green-500', 'bg-blue-500', 'bg-purple-500', 'bg-red-500', 'bg-yellow-500', 'bg-pink-500', 'bg-indigo-500', 'bg-teal-500'];
            if (!toolName) return colors[0];
            const hash = toolName.split('').reduce((a, b) => {
                a = ((a << 5) - a) + b.charCodeAt(0);
                return a & a;
            }, 0);
            return colors[Math.abs(hash) % colors.length];
        }

        // DB 기반 도구 아이콘 가져오기 함수
        async function getToolIconFromDB(toolName) {
            try {
                // 이미 로드된 도구 정보가 있으면 사용
                if (window.toolInfoCache && window.toolInfoCache[toolName]) {
                    return window.toolInfoCache[toolName].icon || 'fas fa-cog';
                }
                
                // DB에서 도구 정보 조회
                const toolDoc = await getDoc(doc(db, 'ai-tools', toolName));
                if (toolDoc.exists()) {
                    const toolData = toolDoc.data();
                    return toolData.icon || 'fas fa-cog';
                }
                
                return 'fas fa-cog'; // 기본값
            } catch (error) {
                console.error('도구 아이콘 로드 실패:', error);
                return 'fas fa-cog';
            }
        }

        // 도구 정보가 없는 경우 기본 아이콘 매핑 (폴백)
        function getFallbackToolIcon(toolName) {
            const fallbackIcons = {
                'ChatGPT': 'fas fa-comments',
                'Discord': 'fas fa-comments',
                'Slack': 'fas fa-comments',
                'Zoom': 'fas fa-video',
                'Google Meet': 'fas fa-video',
                'Microsoft Teams': 'fas fa-users',
                'Notion': 'fas fa-sticky-note',
                'Canva': 'fas fa-palette',
                'Figma': 'fas fa-paint-brush',
                'Photoshop': 'fas fa-paint-brush',
                'GitHub Copilot': 'fas fa-code',
                'Midjourney': 'fas fa-palette',
                'DALL-E': 'fas fa-image'
            };
            
            return fallbackIcons[toolName] || 'fas fa-cog';
        }

        // 도구 아이콘 가져오기 (통합 함수)
        async function getToolIcon(toolName) {
            try {
                // 1. DB에서 먼저 시도
                const dbIcon = await getToolIconFromDB(toolName);
                if (dbIcon && dbIcon !== 'fas fa-cog') {
                    return dbIcon;
                }
                
                // 2. 폴백 아이콘 사용
                return getFallbackToolIcon(toolName);
            } catch (error) {
                console.error('도구 아이콘 가져오기 실패:', error);
                // 3. 최종 폴백
                return getFallbackToolIcon(toolName);
            }
        }

        // AI 도구 카드 생성 함수
        function createToolCard(tool, toolId) {
            return `
                <div class="tool-card card-component" role="article" aria-label="${tool.name} AI 도구">
                    <div class="tool-thumbnail">
                        <img src="${getValidImageUrl(tool)}" alt="${tool.name}" onerror="window.handleImageError(this)" loading="lazy">
                    </div>
                    <div class="tool-content">
                        <div class="tool-header">
                            <div class="tool-title">${tool.name}</div>
                            <i class="fas fa-bookmark bookmark-icon" title="즐겨찾기됨" aria-hidden="true"></i>
                        </div>
                        <p class="tool-description">${tool.description}</p>
                        <div class="tag-container tag-list-clamp">
                            ${(tool.tags || []).map(tag => `<span class="tag tag-component">${tag}</span>`).join('')}
                        </div>
                        <!-- 버튼 추가 영역 -->
                        <div class="flex gap-2 mb-2">
                            <a href="${tool.websiteUrl || '#'}" target="_blank" rel="noopener noreferrer" class="btn-component primary small flex-1" aria-label="${tool.name} 웹사이트 방문">
                                웹사이트 방문
                            </a>
                            <button class="btn-component secondary small flex-1" onclick="shareTool('${tool.name}', '${tool.websiteUrl || ''}')" aria-label="${tool.name} 공유하기">
                                공유하기
                            </button>
                        </div>
                        <button class="btn-component primary w-full mt-2" onclick="location.href='detail_sp.html?id=${toolId}'" aria-label="${tool.name} 상세 정보 보기">
                            상세 정보 페이지 이동
                        </button>
                        <div class="tool-footer">
                            <span class="text-sm font-medium text-gray-300">${tool.type}</span>
                            <span class="text-sm text-gray-400">${tool.reviewCount || 0} reviews</span>
                            <button class="btn-component error small" onclick="removeFavoriteTool('${toolId}')" aria-label="${tool.name} 즐겨찾기에서 삭제">
                                삭제
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // AI 레시피 카드 생성 함수
        async function createRecipeCard(recipeData, docId) {
            const card = document.createElement('div');
            card.className = 'recipe-card p-4 sm:p-6';
            card.setAttribute('role', 'article');
            card.setAttribute('aria-label', `${recipeData.title || recipeData.my_recipe_title || 'AI 레시피'}`);
            
            // 카드 클릭 이벤트 추가
            card.style.cursor = 'pointer';
            card.addEventListener('click', function(e) {
                // 버튼 클릭 시에는 상세 페이지로 이동하지 않음
                if (e.target.closest('button')) {
                    return;
                }
                // 상세 페이지로 이동
                window.location.href = `ai_comb_detail.html?id=${docId}`;
            });
            
            // 사용자 아바타 (첫 글자 사용)
            const userName = recipeData.user_id ? recipeData.user_id.substring(0, 1) : 'U';
            const avatarColor = getAvatarColor(recipeData.user_id);
            
            // Firestore 데이터 구조에 맞춰 필드명 수정
            const recipeTitle = recipeData.title || recipeData.my_recipe_title || 'Untitled Recipe';
            const recipeDescription = recipeData.description || recipeData.my_recipe_basic_description || '';
            const tools = recipeData.tools || recipeData.my_recipe_tool || [];
            
            // 도구 아이콘과 이름 생성 (최대 4개까지 표시, 초과 시 3개만 표시)
            const maxTools = tools.length > 4 ? 3 : 4;
            const displayTools = tools.slice(0, maxTools);
            
            // 도구 아이콘들을 비동기로 생성
            let toolElements = '';
            for (let i = 0; i < displayTools.length; i++) {
                const tool = displayTools[i];
                const toolImage = window.toolImagesCache ? window.toolImagesCache[tool] : null;
                const bgColor = getToolColor(tool);
                
                // DB에서 아이콘 정보 가져오기
                const iconClass = await getToolIcon(tool);
                
                let toolIcon;
                if (toolImage) {
                    // DB에서 가져온 이미지가 있는 경우
                    toolIcon = `
                        <div class="recipe-tool-icon ${bgColor}" style="padding: 2px;">
                            <img src="${toolImage}" alt="${tool}" style="width: 100%; height: 100%; object-fit: contain; border-radius: 4px; max-width: 100%; max-height: 100%;" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\\'${iconClass}\\'></i>';" loading="lazy">
                        </div>
                    `;
                } else {
                    // 기본 아이콘 사용
                    toolIcon = `
                        <div class="recipe-tool-icon ${bgColor}">
                            <i class="${iconClass}"></i>
                        </div>
                    `;
                }
                
                toolElements += `
                    <div class="recipe-tool-container">
                        ${toolIcon}
                        <div class="recipe-tool-name">${tool}</div>
                    </div>
                    ${i < displayTools.length - 1 ? '<i class="fas fa-arrow-right recipe-arrow mx-1"></i>' : ''}
                `;
            }

            // 4개를 초과하는 도구가 있을 경우 추가 표시
            const additionalToolsCount = tools.length - maxTools;
            if (tools.length > 4) {
                toolElements += `
                    <i class="fas fa-arrow-right recipe-arrow mx-1"></i>
                    <div class="recipe-tool-container">
                        <div class="recipe-tool-icon bg-gray-500 flex items-center justify-center">
                            <span class="text-xs font-bold">+${additionalToolsCount}</span>
                        </div>
                        <div class="recipe-tool-name">추가</div>
                    </div>
                `;
            }

            card.innerHTML = `
                <div class="flex-1">
                    <div class="text-left mb-10">
                        <h3 class="text-lg font-semibold mb-3 line-clamp-2" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; line-height: 1.4; color: var(--text-primary);">${recipeTitle}</h3>
                        <p class="text-sm text-gray-400 line-clamp-3" style="display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; line-height: 1.4;">${recipeDescription}</p>
                    </div>
                    
                    <div class="flex items-center justify-center mb-6 overflow-hidden">
                        ${toolElements}
                    </div>
                    
                    <div class="flex items-center justify-center space-x-4 text-sm mb-4">
                        <div class="flex items-center">
                            <i class="fas fa-heart text-red-500 mr-1" aria-hidden="true"></i>
                            <span>${recipeData.likes_count || 0}</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-comment text-blue-500 mr-1" aria-hidden="true"></i>
                            <span>${recipeData.comments_count || 0}</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-bookmark text-yellow-500 mr-1" aria-hidden="true"></i>
                            <span>${recipeData.bookmarks_count || 0}</span>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-center space-x-2 mt-auto">
                    <button class="btn-component primary text-sm px-4 py-2 flex-1" onclick="event.stopPropagation(); showRecipeSummary('${docId}', ${JSON.stringify(recipeData).replace(/"/g, '&quot;')})" aria-label="레시피 요약 보기">
                        레시피 요약
                    </button>
                    <button class="btn-component error text-sm px-4 py-2 flex-1" onclick="event.stopPropagation(); removeFavoriteRecipe('${docId}')" aria-label="즐겨찾기에서 삭제">
                        삭제
                    </button>
                </div>
            `;

            return card;
        }

        // 레시피 요약 모달 표시 함수
        window.showRecipeSummary = function(docId, recipeData) {
            const modal = document.getElementById('recipeSummaryModal');
            const title = document.getElementById('recipeSummaryTitle');
            const content = document.getElementById('recipeSummaryContent');
            
            if (modal && title && content) {
                // Firestore 데이터 구조에 맞춰 필드명 수정
                const recipeTitle = recipeData.title || recipeData.my_recipe_title || '레시피 제목 없음';
                const recipeDescription = recipeData.description || recipeData.my_recipe_basic_description || '설명이 없습니다.';
                const tools = recipeData.tools || recipeData.my_recipe_tool || [];
                const category = recipeData.category || recipeData.my_recipe_category || '카테고리 없음';
                const difficulty = recipeData.difficulty || recipeData.my_recipe_difficulty || '난이도 정보 없음';
                const recommendedGroups = recipeData.recommendedGroups || recipeData.my_recipe_recommended_groups || [];
                
                title.textContent = recipeTitle;
                
                const toolList = tools.map(tool => `<li class="mb-2"><i class="fas fa-check text-green-500 mr-2"></i>${tool}</li>`).join('');
                
                content.innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <h3 class="font-semibold mb-2">레시피 설명</h3>
                            <p class="text-sm text-gray-600">${recipeDescription}</p>
                        </div>
                        
                        <div>
                            <h3 class="font-semibold mb-2">사용된 AI 도구</h3>
                            <ul class="list-none space-y-1">
                                ${toolList}
                            </ul>
                        </div>
                        
                        <div>
                            <h3 class="font-semibold mb-2">카테고리</h3>
                            <p class="text-sm text-gray-600">${category}</p>
                        </div>
                        
                        <div>
                            <h3 class="font-semibold mb-2">난이도</h3>
                            <p class="text-sm text-gray-600">${difficulty}</p>
                        </div>
                        
                        <div>
                            <h3 class="font-semibold mb-2">추천 대상</h3>
                            <p class="text-sm text-gray-600">${recommendedGroups.join(', ') || '추천 대상 정보 없음'}</p>
                        </div>
                        
                        <div class="flex justify-end space-x-2 pt-4">
                            <button onclick="closeRecipeSummary()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                                닫기
                            </button>
                            <button onclick="location.href='ai_comb_detail.html?id=${docId}'" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                                상세 보기
                            </button>
                        </div>
                    </div>
                `;
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        };

        // 레시피 요약 모달 닫기 함수
        window.closeRecipeSummary = function() {
            const modal = document.getElementById('recipeSummaryModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        };

        // 즐겨찾기 삭제 함수 (Firestore용)
        window.removeFavoriteTool = async function(toolId) {
            if (!confirm('정말로 이 도구를 즐겨찾기에서 삭제하시겠습니까?')) return;
            const user = auth.currentUser;
            if (!user) return;
            const db = getFirestore(app);
            const favDocRef = doc(db, `users/${user.uid}/favorites/${toolId}`);
            try {
                await deleteDoc(favDocRef);
                window.location.reload();
            } catch (e) {
                if (window.CommonUtils) {
                    window.CommonUtils.handleError(e, '즐겨찾기 도구 삭제');
                } else {
                    alert('삭제 중 오류가 발생했습니다.');
                }
            }
        }

        // 즐겨찾기 레시피 삭제 함수
        window.removeFavoriteRecipe = async function(recipeId) {
            if (!confirm('정말로 이 레시피를 즐겨찾기에서 삭제하시겠습니까?')) return;
            const user = auth.currentUser;
            if (!user) return;
            
            try {
                const db = getFirestore(app);
                const favDocRef = doc(db, `users/${user.uid}/favorited_recipe/${recipeId}`);
                await deleteDoc(favDocRef);
                window.location.reload();
            } catch (e) {
                if (window.CommonUtils) {
                    window.CommonUtils.handleError(e, '즐겨찾기 레시피 삭제');
                } else {
                    console.error('레시피 삭제 오류:', e);
                    if (e.code === 'permission-denied') {
                        alert('삭제 권한이 없습니다. 관리자에게 문의하세요.');
                    } else {
                        alert('삭제 중 오류가 발생했습니다.');
                    }
                }
            }
        }

        // 공유하기 함수
        window.shareTool = function(name, url) {
            window._shareUrl = url;
            window._shareName = name;
            document.getElementById('shareModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
    </script>

    <!-- 공유하기 모달 -->
    <div id="shareModal" class="modal-overlay" style="display:none;">
      <div class="modal">
        <div class="modal-close" onclick="closeShareModal()">
          <i class="fas fa-times"></i>
        </div>
        <div class="text-center mb-6">
          <h2 class="text-2xl font-bold text-white">공유하기</h2>
        </div>
        <div class="grid grid-cols-4 gap-4 mb-4">
          <button onclick="shareEmail()" class="flex flex-col items-center">
            <span class="bg-blue-400 rounded-full w-12 h-12 flex items-center justify-center mb-1"><i class="fas fa-envelope text-white text-xl"></i></span>
            <span class="text-xs text-white">메일</span>
          </button>
          <button onclick="shareReddit()" class="flex flex-col items-center">
            <span class="bg-orange-500 rounded-full w-12 h-12 flex items-center justify-center mb-1"><i class="fab fa-reddit text-white text-xl"></i></span>
            <span class="text-xs text-white">Reddit</span>
          </button>
          <button onclick="shareWhatsApp()" class="flex flex-col items-center">
            <span class="bg-green-500 rounded-full w-12 h-12 flex items-center justify-center mb-1"><i class="fab fa-whatsapp text-white text-xl"></i></span>
            <span class="text-xs text-white">WhatsApp</span>
          </button>
          <button onclick="shareSms()" class="flex flex-col items-center">
            <span class="bg-green-300 rounded-full w-12 h-12 flex items-center justify-center mb-1"><i class="fas fa-sms text-white text-xl"></i></span>
            <span class="text-xs text-white">메시지</span>
          </button>
          <button onclick="shareX()" class="flex flex-col items-center">
            <span class="bg-black rounded-full w-12 h-12 flex items-center justify-center mb-1"><i class="fab fa-x-twitter text-white text-xl"></i></span>
            <span class="text-xs text-white">X</span>
          </button>
          <button onclick="shareFacebook()" class="flex flex-col items-center">
            <span class="bg-blue-700 rounded-full w-12 h-12 flex items-center justify-center mb-1"><i class="fab fa-facebook-f text-white text-xl"></i></span>
            <span class="text-xs text-white">Facebook</span>
          </button>
          <button onclick="shareLine()" class="flex flex-col items-center">
            <span class="bg-green-600 rounded-full w-12 h-12 flex items-center justify-center mb-1"><i class="fab fa-line text-white text-xl"></i></span>
            <span class="text-xs text-white">Line</span>
          </button>
          <button onclick="shareKakao()" class="flex flex-col items-center">
            <span class="bg-yellow-400 rounded-full w-12 h-12 flex items-center justify-center mb-1"><i class="fas fa-comment text-white text-xl"></i></span>
            <span class="text-xs text-white">카카오톡</span>
          </button>
        </div>
        <button onclick="copyShareLink()" class="w-full flex items-center bg-gray-700 text-white px-4 py-2 rounded mb-2">
          <i class="fas fa-link mr-2"></i> 링크 복사
        </button>
      </div>
    </div>

    <!-- 레시피 요약 모달 -->
    <div id="recipeSummaryModal" class="fixed inset-0 bg-black bg-opacity-50 z-[9999] hidden flex items-center justify-center p-4" onclick="closeRecipeSummary()">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto border border-gray-200 dark:border-gray-700" onclick="event.stopPropagation()" style="background-color: var(--card-bg); border-color: var(--border-color);">
            <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700" style="border-color: var(--border-color);">
                <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200" id="recipeSummaryTitle" style="color: var(--text-primary);"></h2>
                <button onclick="closeRecipeSummary()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200" style="color: var(--text-secondary);">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 bg-white dark:bg-gray-800" id="recipeSummaryContent" style="background-color: var(--card-bg); color: var(--text-primary);">
                <!-- 내용이 동적으로 채워집니다 -->
            </div>
        </div>
    </div>

    <!-- 공유하기 모달 열기/닫기 함수 및 각 플랫폼별 공유 함수 -->
    <script>
    window.closeShareModal = function() {
        document.getElementById('shareModal').style.display = 'none';
        document.body.style.overflow = '';
    }
    window.copyShareLink = function() {
        if (!window._shareUrl) return;
        navigator.clipboard.writeText(window._shareUrl)
            .then(() => alert('링크가 복사되었습니다.'))
            .catch(err => alert('링크 복사 실패: ' + err));
    }
    window.shareEmail = function() {
        if (!window._shareUrl) return;
        const subject = encodeURIComponent('AI 도구 추천');
        const body = encodeURIComponent(`${window._shareName}\n${window._shareUrl}`);
        window.open(`mailto:?subject=${subject}&body=${body}`);
    }
    window.shareSms = function() {
        if (!window._shareUrl) return;
        const body = encodeURIComponent(`${window._shareName}\n${window._shareUrl}`);
        window.open(`sms:?body=${body}`);
    }
    window.shareX = function() {
        if (!window._shareUrl) return;
        const text = encodeURIComponent(`${window._shareName} - ${window._shareUrl}`);
        window.open(`https://twitter.com/intent/tweet?text=${text}`, '_blank');
    }
    window.shareFacebook = function() {
        if (!window._shareUrl) return;
        window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window._shareUrl)}`, '_blank');
    }
    window.shareLine = function() {
        if (!window._shareUrl) return;
        window.open(`https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(window._shareUrl)}`, '_blank');
    }
    window.shareReddit = function() {
        if (!window._shareUrl) return;
        const title = encodeURIComponent(window._shareName);
        window.open(`https://www.reddit.com/submit?url=${encodeURIComponent(window._shareUrl)}&title=${title}`, '_blank');
    }
    window.shareWhatsApp = function() {
        if (!window._shareUrl) return;
        const text = encodeURIComponent(`${window._shareName} ${window._shareUrl}`);
        window.open(`https://wa.me/?text=${text}`, '_blank');
    }
    window.shareKakao = function() {
        if (!window._shareUrl) return;
        // 카카오톡 공유는 공식 JS SDK가 필요하지만, 간단히 링크 공유로 대체
        const text = encodeURIComponent(`${window._shareName} ${window._shareUrl}`);
        window.open(`https://sharer.kakao.com/talk/friends/picker/link?url=${encodeURIComponent(window._shareUrl)}&text=${text}`, '_blank');
    }
    </script>

    <script>
        // 테마1 전환 관련 코드
        document.addEventListener('DOMContentLoaded', () => {
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = themeToggle.querySelector('i');
            
            // 저장된 테마 불러오기
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
            
            // 테마 토글 이벤트
            themeToggle.addEventListener('click', () => {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcon(newTheme);
            });
            
            // 테마 아이콘 업데이트
            function updateThemeIcon(theme) {
                if (theme === 'dark') {
                    themeIcon.className = 'fas fa-sun';
                } else {
                    themeIcon.className = 'fas fa-moon';
                }
            }
        });
    </script>

  
    <!-- profile.html에서만 header 우측 메뉴 커스텀 -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        function customizeProfileHeader() {
            const profileMenu = document.getElementById('profileMenu');
            if (!profileMenu) {
                setTimeout(customizeProfileHeader, 100);
                return;
            }
            // "로그아웃" 버튼만 노출
            profileMenu.innerHTML = `
                <span id="profileHeaderLogout" class="text-indigo-400 cursor-pointer hover:underline">로그아웃</span>
            `;
            // 로그아웃 이벤트 연결
            document.getElementById('profileHeaderLogout').onclick = async function() {
                try {
                    // Firebase auth 인스턴스 가져오기
                    const { getAuth, signOut } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js');
                    const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js');
                    import('./js/config.js').then(({ firebaseConfig }) => {
                        const app = initializeApp(firebaseConfig);
                        const auth = getAuth(app);
                        signOut(auth).then(() => {
                            if (window.CommonUtils) {
                                window.CommonUtils.showSuccess('로그아웃되었습니다.');
                            } else {
                                alert('로그아웃되었습니다.');
                            }
                            window.location.href = 'index.html';
                        }).catch((error) => {
                            if (window.CommonUtils) {
                                window.CommonUtils.handleError(error, '로그아웃');
                            } else {
                                alert('로그아웃 중 오류가 발생했습니다.');
                            }
                        });
                    });
                } catch (error) {
                    if (window.CommonUtils) {
                        window.CommonUtils.handleError(error, '로그아웃');
                    } else {
                        alert('로그아웃 중 오류가 발생했습니다.');
                    }
                }
            };
        }
        customizeProfileHeader();
    });
    </script>
</body>
</html> 